import{a as $,b as z}from"./chunk-GFF2Z7V3.js";import{a as q}from"./chunk-SNQC5Y52.js";import{a as N}from"./chunk-XYLGNDH5.js";import{e as H}from"./chunk-DRKJIXPH.js";import"./chunk-KKWS45KX.js";import{$a as p,Aa as l,Ba as g,Ca as w,Fb as R,Gb as P,H as U,Hb as F,La as I,Na as x,Sb as k,Ub as L,Ya as B,Yb as j,Za as C,a as y,ab as f,b,bb as T,ca as c,cb as E,f as _,ga as h,ka as O,la as M,m as S,oa as D,za as m}from"./chunk-5Q5JURXL.js";function Q(r,d){if(r&1&&(l(0,"div",17),w(1,"span",18),l(2,"span",19),p(3),g(),l(4,"span",20),p(5),l(6,"span",6),p(7),g()()()),r&2){let u=d.$implicit,t=x(2);c(),B("background",t.getColorForUnit(u)),c(2),f(u.name),c(2),E("",u.totalAmount>=0?" +":"","",u.totalAmount," "),c(2),f(t.selectedBudget==null?null:t.selectedBudget.currency)}}function W(r,d){if(r&1&&(l(0,"div",15),w(1,"h3"),D(2,Q,8,6,"div",16),g()),r&2){let u=x();c(2),m("ngForOf",u.getFilteredUnits())}}function X(r,d){if(r&1&&(l(0,"div",17),w(1,"span",18),l(2,"span",19),p(3),g(),l(4,"span",20),p(5),l(6,"span",6),p(7),g()()()),r&2){let u=d.$implicit,t=x(3);c(),B("background",t.getColorForTransaction(u)),c(2),f(u.note||""),c(2),E("",u.isDeposit?"+":"-","",u.amount," "),c(2),f(t.selectedBudget==null?null:t.selectedBudget.currency)}}function Y(r,d){if(r&1&&(l(0,"div",15),D(1,X,8,6,"div",16),g()),r&2){let u=x(2);c(),m("ngForOf",u.filteredTransactions)}}function Z(r,d){if(r&1&&(l(0,"div"),D(1,Y,2,1,"div",13),g()),r&2){let u=x();c(),m("ngIf",u.filteredTransactions.length>0)}}var J=(()=>{let d=class d{constructor(t,s,n,e,i,a){this.userService=t,this._budgetunitService=s,this._budgettransactionService=n,this.budgetService=e,this.route=i,this.router=a,this.isMenuOpen=!1,this.selectedType=null,this.budgetBalance=0,this.units=[],this.budgets=[],this.selectedBudgetId=null,this.selectedUnitId=null,this.selectedBudget=null,this.selectedUnit=null,this.transactions=[],this.selectedRange={start:null,end:null}}ngOnInit(){return _(this,null,function*(){if(this.budgets=yield this.budgetService.getAllBudgets(),!this.budgets||this.budgets.length===0){this.router.navigate(["/budgets"]);return}let t=localStorage.getItem("selectedBudgetId"),s;if(t)s=this.budgets.find(e=>e._id===t);else{let e=this.route.snapshot.queryParamMap.get("budget");e&&(s=this.budgets.find(i=>i._id===e))}s&&(this.selectedBudgetId=s._id,this.selectedBudget=s,localStorage.setItem("selectedBudgetId",s._id),localStorage.setItem("selectedBudgetName",s.name),yield this.loadBudgetData(s),window.dispatchEvent(new CustomEvent("budgetChanged",{detail:s}))),this.route.queryParams.subscribe(e=>_(this,null,function*(){let i=e.budget;if(!i||i===s?._id)return;let a=this.budgets.find(o=>o._id===i);a&&(yield this.loadBudgetData(a),window.dispatchEvent(new CustomEvent("budgetChanged",{detail:a})))})),this.budgetListener=e=>_(this,null,function*(){let i=e.detail;i?._id&&(this.selectedBudget=i,this.units=yield S(this._budgetunitService.getUnitsByBudget(i._id)),this.transactions=yield S(this._budgettransactionService.getTransactionsByBudget(i._id)),this.updateUnitsTotals(),this.selectedUnit=null,this.selectedUnitId=null)}),window.addEventListener("budgetChanged",this.budgetListener),this.unitListener=e=>{let i=e.detail;this.selectedUnit=i||null,this.selectedUnitId=i||null},window.addEventListener("unitChanged",this.unitListener),this.transactionListener=e=>{let i=e.detail;i.budget===this.selectedBudgetId&&(this.transactions=[...this.transactions,i],this.updateUnitsTotals())},window.addEventListener("transactionCreated",this.transactionListener),this.dateRangeListener=e=>{this.selectedRange={start:e.detail.start?new Date(e.detail.start):null,end:e.detail.end?new Date(e.detail.end):null},this.updateUnitsTotals()},window.addEventListener("dateRangeChanged",this.dateRangeListener);let n=localStorage.getItem("dateRange");if(n){let e=JSON.parse(n);this.selectedRange={start:e.start?new Date(e.start):null,end:e.end?new Date(e.end):null}}})}loadBudgetData(t){return _(this,null,function*(){this.selectedBudget=t,this.units=yield S(this._budgetunitService.getUnitsByBudget(t._id)),this.transactions=yield S(this._budgettransactionService.getTransactionsByBudget(t._id)),this.updateUnitsTotals(),this.units=this.units.map(s=>{let n=this.transactions.reduce((e,i)=>{if(!this.isTransactionInRange(i))return e;if(i.unitId&&String(i.unitId)===String(s._id))return e+(i.isDeposit?i.amount:-i.amount);if(i.units){let a=i.units.find(o=>String(o.unit)===String(s._id));if(a)return e+(i.isDeposit?a.amount:-a.amount)}return e},0);return b(y({},s),{totalAmount:n})})})}updateUnitsTotals(){this.units=this.units.map(t=>{let s=this.transactions.filter(n=>this.isTransactionInRange(n)).filter(n=>this.selectedType?this.selectedType==="income"?n.isDeposit:!n.isDeposit:!0).reduce((n,e)=>{if(e.unitId&&String(e.unitId)===String(t._id))return n+(e.isDeposit?e.amount:-e.amount);if(e.units){let i=e.units.find(a=>String(a.unit)===String(t._id));if(i)return n+(e.isDeposit?i.amount:-i.amount)}return n},0);return b(y({},t),{totalAmount:s})})}selectType(t){this.selectedType===t?this.selectedType=null:this.selectedType=t,this.updateUnitsTotals()}onUnitChange(t){this.selectedUnitId=t,this.selectedUnit=t,window.dispatchEvent(new CustomEvent("unitChanged",{detail:t}))}ngOnDestroy(){window.removeEventListener("budgetChanged",this.budgetListener),window.removeEventListener("unitChanged",this.unitListener),window.removeEventListener("transactionCreated",this.transactionListener),this.dateRangeListener&&window.removeEventListener("dateRangeChanged",this.dateRangeListener)}selectUnit(t){this.selectedUnit=t,this.selectedUnitId=t,window.dispatchEvent(new CustomEvent("unitChanged",{detail:t}))}getEndOfDay(t){let s=new Date(t);return s.setHours(23,59,59,999),s}get filteredTransactions(){return this.transactions.filter(t=>this.selectedUnit?t.unitId&&String(t.unitId)===String(this.selectedUnit)||t.units&&t.units.some(s=>String(s.unit)===String(this.selectedUnit)):!0).filter(t=>this.selectedType?this.selectedType==="income"?t.isDeposit:!t.isDeposit:!0).filter(t=>{if(this.selectedRange.start&&this.selectedRange.end&&t._id){let s=parseInt(t._id.substring(0,8),16)*1e3,n=new Date(s),e=this.getEndOfDay(this.selectedRange.end);return n>=this.selectedRange.start&&n<=e}return!0}).map(t=>{let s=t.amount;if(this.selectedUnit){if(t.unitId&&String(t.unitId)===String(this.selectedUnit))s=t.isDeposit?t.amount:-t.amount;else if(t.units){let n=t.units.find(e=>String(e.unit)===String(this.selectedUnit));n&&(s=t.isDeposit?n.amount:-n.amount)}}else!t.unitId&&!t.units&&(s=t.isDeposit?t.amount:-t.amount);return b(y({},t),{displayAmount:s})})}isTransactionInRange(t){if(this.selectedRange.start&&this.selectedRange.end&&t._id){let s=parseInt(t._id.substring(0,8),16)*1e3,n=new Date(s),e=this.getEndOfDay(this.selectedRange.end);return n>=this.selectedRange.start&&n<=e}return!0}getFilteredUnits(){return this.units.map(t=>{let n=this.transactions.filter(e=>String(e.unitId)===String(t._id)||e.units&&e.units.some(i=>String(i.unit)===String(t._id))).filter(e=>this.selectedType?this.selectedType==="income"?e.isDeposit:!e.isDeposit:!0).filter(e=>this.isTransactionInRange(e)).reduce((e,i)=>{if(i.unitId&&String(i.unitId)===String(t._id))return e+(i.isDeposit?i.amount:-i.amount);if(i.units){let a=i.units.find(o=>String(o.unit)===String(t._id));if(a)return e+(i.isDeposit?a.amount:-a.amount)}return e},0);return b(y({},t),{totalAmount:n})}).filter(t=>t.totalAmount!==0)}getTotalByType(t){let s=t==="income",n=this.selectedRange.end?this.getEndOfDay(this.selectedRange.end):null;return(this.selectedUnit?this.filteredTransactions:this.transactions).filter(i=>i.isDeposit===s).filter(i=>{if(this.selectedRange.start&&n&&i._id){let a=parseInt(i._id.substring(0,8),16)*1e3,o=new Date(a);return o>=this.selectedRange.start&&o<=n}return!0}).reduce((i,a)=>{if(this.selectedUnit){if(a.unitId&&String(a.unitId)===String(this.selectedUnit))return i+a.amount;if(a.units){let o=a.units.find(v=>String(v.unit)===String(this.selectedUnit));if(o)return i+o.amount}return i}else return a.unitId?i+a.amount:a.units?i+a.units.reduce((o,v)=>o+v.amount,0):i},0)}getIncomeTotal(){return this.getTotalByType("income")}getExpenseTotal(){return this.getTotalByType("expense")}getBudgetBalance(){if(!this.selectedBudget)return 0;this.selectedBudget.initialAmount===void 0&&(this.selectedBudget.initialAmount=Number(this.selectedBudget.amount)||0);let t=this.transactions.reduce((s,n)=>{let e=n.isDeposit?1:-1;if(n.unitId)return s+e*n.amount;if(n.units&&Array.isArray(n.units)){let i=n.units.reduce((a,o)=>a+(o.amount||0),0);return s+e*i}return s+e*n.amount},0);return this.budgetBalance=this.selectedBudget.initialAmount+t,this.budgetBalance}getCircleTotal(){let t;if(this.selectedUnit){let s=this.transactions.filter(n=>String(n.unitId)===String(this.selectedUnit)||n.units&&n.units.some(e=>String(e.unit)===String(this.selectedUnit)));if(this.selectedType){let n=this.selectedType==="income";t=s.filter(e=>e.isDeposit===n).reduce((e,i)=>{if(i.unitId&&String(i.unitId)===String(this.selectedUnit))return e+i.amount;if(i.units){let a=i.units.find(o=>String(o.unit)===String(this.selectedUnit));if(a)return e+a.amount}return e},0),t=n?t:-t}else t=s.reduce((n,e)=>{if(e.unitId&&String(e.unitId)===String(this.selectedUnit))return n+(e.isDeposit?e.amount:-e.amount);if(e.units){let i=e.units.find(a=>String(a.unit)===String(this.selectedUnit));if(i)return n+(e.isDeposit?i.amount:-i.amount)}return n},0)}else this.selectedType?(t=this.getTotalByType(this.selectedType),t=this.selectedType==="income"?t:-t):t=this.getIncomeTotal()-this.getExpenseTotal();return t>0?`+${t}`:`${t}`}getCategoriesData(){let t={};this.selectedUnit?this.filteredTransactions.forEach(n=>{let e=n.note||"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0456\u0457";t[e]=(t[e]||0)+n.amount}):this.getFilteredUnits().forEach(n=>{(n.totalAmount||0)!==0&&(t[n.name]=Math.abs(n.totalAmount))});let s=Object.values(t).reduce((n,e)=>n+e,0);return{categories:t,total:s}}get circleChartStyle(){let t={},s=0;if(this.selectedUnit?this.filteredTransactions.forEach(a=>{let o=a.note||"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0456\u0457";t[o]=(t[o]||0)+Math.abs(a.displayAmount),s+=Math.abs(a.displayAmount)}):this.getFilteredUnits().forEach(a=>{this.selectedType?this.selectedType==="income"&&a.totalAmount>0?(t[a.name]=a.totalAmount,s+=a.totalAmount):this.selectedType==="expense"&&a.totalAmount<0&&(t[a.name]=Math.abs(a.totalAmount),s+=Math.abs(a.totalAmount)):(t[a.name]=Math.abs(a.totalAmount),s+=Math.abs(a.totalAmount))}),s===0)return{background:"#ccc",borderRadius:"50%"};let n=["#005F73","#0A9396","#94D2BD","#E9D8A6","#EE9B00","#CA6702","#BB3E03","#AE2012","#023E58","#127475","#7FB3A5","#DAD7A7","#F4A300","#D15600","#A63200"],e=0;return{background:`conic-gradient(${Object.entries(t).map(([a,o],v)=>{let V=o/s*100,A=e+V,G=`${n[v%n.length]} ${e}% ${A}%`;return e=A,G}).join(", ")})`,borderRadius:"50%",width:"200px",height:"200px"}}getColorForTransaction(t){let{categories:s}=this.getCategoriesData(),n=["#005F73","#0A9396","#94D2BD","#E9D8A6","#EE9B00","#CA6702","#BB3E03","#AE2012","#023E58","#127475","#7FB3A5","#DAD7A7","#F4A300","#D15600","#A63200"],e=Object.keys(s).indexOf(t.note||"Other");return n[e%n.length]}getColorForUnit(t){let{categories:s}=this.getCategoriesData(),n=["#005F73","#0A9396","#94D2BD","#E9D8A6","#EE9B00","#CA6702","#BB3E03","#AE2012","#023E58","#127475","#7FB3A5","#DAD7A7","#F4A300","#D15600","#A63200"],e=Object.keys(s).indexOf(t.name);return n[e%n.length]}};d.\u0275fac=function(s){return new(s||d)(h(N),h(q),h(z),h($),h(k),h(L))},d.\u0275cmp=O({type:d,selectors:[["ng-component"]],standalone:!1,decls:22,vars:13,consts:[[1,"documents-wrapper"],[1,"documents-container"],[1,"documents-list"],[1,"documents-main"],[1,"balance-block"],[1,"balance-title"],[1,"currency"],[1,"summary"],["id","incomeTotal",3,"click"],["id","expenseTotal",3,"click"],[1,"circle-chart",3,"ngStyle"],[1,"circle-chart-inner"],[1,"documents-main-content"],["class","categories",4,"ngIf"],[4,"ngIf"],[1,"categories"],["class","category",4,"ngFor","ngForOf"],[1,"category"],[1,"legend-color"],[1,"note"],[1,"amount"]],template:function(s,n){s&1&&(l(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4)(5,"h2",5),p(6),l(7,"span",6),p(8),g()(),l(9,"div",7)(10,"span",8),I("click",function(){return n.selectType("income")}),p(11," Income "),g(),l(12,"span",9),I("click",function(){return n.selectType("expense")}),p(13," Expense "),g()(),l(14,"div",10)(15,"div",11),p(16),l(17,"span",6),p(18),g()()()(),l(19,"div",12),D(20,W,3,1,"div",13)(21,Z,2,1,"div",14),g()()()()()),s&2&&(C("documents-wrapper--open",n.isMenuOpen),c(6),T(" Balance: ",n.getBudgetBalance()," "),c(2),f(n.selectedBudget==null?null:n.selectedBudget.currency),c(2),C("active",n.selectedType==="income"),c(2),C("active",n.selectedType==="expense"),c(2),m("ngStyle",n.circleChartStyle),c(2),T(" ",n.getCircleTotal()," "),c(2),f(n.selectedBudget==null?null:n.selectedBudget.currency),c(2),m("ngIf",!n.selectedUnit),c(),m("ngIf",n.selectedUnit))},dependencies:[R,P,F],styles:[".documents-wrapper[_ngcontent-%COMP%]{min-height:100vh;font-family:Arial,sans-serif;background-color:#2b2b2b;padding-bottom:30px}.balance-block[_ngcontent-%COMP%]{background-color:#373535;color:#ecebeb;width:100%;padding:15px 20px 60px;margin-top:50px;border-radius:0 0 20px 20px;text-align:center;position:relative;box-shadow:0 4px 8px #0000004d}.balance-title[_ngcontent-%COMP%]{font-size:25px;margin-bottom:20px}.summary[_ngcontent-%COMP%]{display:flex;justify-content:space-between;position:absolute;bottom:20px;left:20px;right:20px}.summary[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{cursor:pointer;font-weight:700;padding:5px 10px;border-bottom:2px solid transparent;transition:border-color .2s}.summary[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:hover{border-color:#ffffff4d}.summary[_ngcontent-%COMP%]   span.active[_ngcontent-%COMP%]{border-color:#ecebeb}.circle-chart[_ngcontent-%COMP%]{width:250px;height:250px;margin:0 auto;border-radius:50%;background:#2f2e2e;position:relative}.circle-chart-inner[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;width:120px;height:120px;background:#373535;border-radius:50%;transform:translate(-50%,-50%);display:flex;justify-content:center;align-items:center;color:#ecebeb;font-weight:700;font-size:18px}.documents-main-content[_ngcontent-%COMP%]{padding:10px 0;display:flex;flex-direction:column;gap:15px;width:90%;margin:0 auto;max-height:calc(100vh - 490px);overflow-y:auto}@media screen and (max-height: 600px){.documents-main-content[_ngcontent-%COMP%]{max-height:calc(100vh - 120px)}}@media screen and (min-width: 1024px){.documents-main-content[_ngcontent-%COMP%]{max-height:200px;width:400px}}.category[_ngcontent-%COMP%]{background-color:#373535;border-radius:12px;padding:15px 20px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px #0003}.legend-color[_ngcontent-%COMP%]{width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:10px}.note[_ngcontent-%COMP%]{flex:1;font-size:15px;color:#ecebeb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.amount[_ngcontent-%COMP%]{font-weight:700;min-width:80px;text-align:right}.currency[_ngcontent-%COMP%]{font-size:13px;margin-left:5px}@media screen and (min-width: 768px){.circle-block[_ngcontent-%COMP%], .documents-main-content[_ngcontent-%COMP%]{width:400px}}"]});let r=d;return r})();var tt=[{path:"",component:J}],ht=(()=>{let d=class d{};d.\u0275fac=function(s){return new(s||d)},d.\u0275mod=M({type:d}),d.\u0275inj=U({imports:[j.forChild(tt),H]});let r=d;return r})();export{ht as DashboardModule};
